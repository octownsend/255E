---
title: "Portfolio_Outline"
author: "Olivia Townsend"
date: "11/1/2017"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Data Collection
The Red-tailed Tropicbird (Phaethon rubricauda) is common throughout the tropical Indian and Pacific Oceans, yet there is little information about its behavior at sea, particularly in the central Pacific where there are sizeable breeding populations in the Hawaiian Islands. We GPS-tracked adult chick-rearing tropicbirds (n=22) from a colony on Oahu during April–May 2017 in order to collect information on their distribution and habitat use at sea. Birds were captured by hand on their nest before a foraging trip, weighed in a cloth sack using a spring scale, banded, and fitted with a tracking device. Lightweight archival GPS loggers weighing 18-20g (i-gotU GT-120) were taped to 3-4 central tail feathers using adhesive tape (Tesa, Germany) and configured to a sampling rate of 3 minutes. The weight of the logger represented 2-3% of the bird’s body mass, therefore not exceeding the 3-5% recommended threshold for seabirds. When a GPS-tagged bird returned from its trip to sea, the logger and tape were removed and the bird was sampled, then released at its nest. 
Morphometric measurements (body mass, culmen length, head and bill length, wing chord) were taken from each study individual after the GPS logger was retrieved following standardized protocols reported in the literature. 
A drop of blood was collected onto a Whatman card for every tracked bird to be used for molecular sexing. A 0.25 mL blood sample was also collected from 14 birds for stable isotope analysis (SIA) of δ 15N and δ 13C. SIA is increasingly becoming a useful tool for approximating the diet of foraging individuals as it provides information on a consumer’s trophic position and type of foraging area. Blood was drawn using a 1 mL syringe with a 25-gauge needle from the metatarsal vein on the leg using aseptic methods. This form of blood extraction is commonly used in bird studies since it appears to have no negative effects on foraging and survival. The sample was then frozen at -20°C until analysis at a later date. In addition, 3-4 body feathers were taken from each tracked bird to be used for SIA in conjunction with the blood samples. While blood provides dietary information for the breeding season, feathers tell us about a bird’s diet earlier in the year when they undergo molt, offering a more comprehensive diet assessment. Lastly, regurgitated samples and food items dropped in the colony were collected for supplemental material since SIA does not provide detailed information on prey identity. There were a total of 9 diet samples collected (7 flying fish spp., 1 squid spp., 1 unknown fish spp).

## Data Files
I have a combination of files to analyze. One file is an Excel version of my field notes, containing information like nest number and band number, deploy time/date and recovery time/date of GPS loggers, morphometric measurements (mass, culmen length, head and bill length, wing chord), and chick stage. I also have individual .csv files of tracking data for each bird, which include latitude, longitude, speed, and altitude for every sampling point.

## Importing the Files

My field notes are in an Excel format, so I need to load the xlsx package and use the read.xlsx() function in order to import them

```{r import_fieldnotes}
library(xlsx)
setwd("~/Desktop/RTTR 2017")
rttr<-read.xlsx("RTTR_2017.xlsx",sheetIndex = 1)
```

I use a for loop to import the 22 .csv tracking files. I also add a bird ID column in order to distinguish the tracks once they are all combined in the "rttrall" dataframe.

```{r import_trackingdata}
fnames = dir("~/Desktop/RTTR 2017/csv files", pattern = ".csv",full.names = TRUE)
for (i in 1:length(fnames)){
  temp=read.csv(fnames[i])
  myfile=basename(fnames[i])
  loc=regexpr(pattern="[[:digit:]]{2}_",text = myfile)
  birdID = substr(myfile,start=loc[[1]],stop = loc[[1]]+1)
  temp$BIRDID= birdID
  if (i==1){
    rttrall = temp
  } else {
    rttrall = rbind(rttrall,temp)}
}
```


## Final Products

# Morphometrics
In addition to making a table of the morphometric data, I am creating a plot in order to display trends among different measurements and the sexes. In tropicbirds, males are typically larger than females and I would like to see if my sampled birds show the same pattern. For now, I am using a 3D scatterplot to graph mass vs. head and bill length vs. wing chord. Once I receive the molecular sexing results, I can color the data points by sex in order to differentiate between males and females.

```{r morphometrics}
library(xlsx)
library(scatterplot3d)
library(knitr)
library("kableExtra")

setwd("~/Desktop/RTTR 2017")
rttr<-read.xlsx("RTTR_2017.xlsx",sheetIndex = 1)
males<-rttr[rttr$Sex=="M",]
females<-rttr[rttr$Sex=="F",]
#undetermined<-rttr[rttr$Sex=="ND",]

#table
kable(rttr[,c(1,13,15,16)], col.names = c("BIRD ID", "MASS (g)", "HEAD AND BILL (mm)", "WING CHORD (mm)"), align = "c")

#graph
scatterplot3d(x=rttr$HEAD...BILL..mm.,y=rttr$WING.CH..mm.,z=rttr$MASS..g.,
              color=as.numeric(rttr$Sex),xlab = "Head and Bill Length (mm)",ylab = "Wing
              Chord (mm)",zlab = "Mass (g)",cex.symbols=1,cex.axis=0.8,pch=19,y.margin.add
              = 0.1)

#red = M
#black = F

sex<-as.vector(rttr$Sex)
mass<-as.vector(rttr$MASS..g.)
culmen<-as.vector(rttr$CULMEN..mm.)
headbill<-as.vector(rttr$HEAD...BILL..mm.)
wingch<-as.vector(rttr$WING.CH..mm.)

boxplot(rttr$MASS..g.[rttr$Sex=="M"],rttr$MASS..g.[rttr$Sex=="F"])
t.test(mass~sex,var.equal=TRUE)

boxplot(rttr$CULMEN..mm.[rttr$Sex=="M"],rttr$CULMEN..mm.[rttr$Sex=="F"])
t.test(culmen~sex,var.equal=TRUE)

boxplot(rttr$HEAD...BILL..mm.[rttr$Sex=="M"],rttr$HEAD...BILL..mm.[rttr$Sex=="F"])
t.test(headbill~sex,var.equal=TRUE)

boxplot(rttr$WING.CH..mm.[rttr$Sex=="M"],rttr$WING.CH..mm.[rttr$Sex=="F"])
t.test(wingch~sex,var.equal=TRUE)
```

# Map of all foraging tracks

```{r all_tracks}
library(maps)
library(maptools)
library(mapdata)
library(prettymapr)
library(lubridate)
library(dplyr)
library(argosfilter)
library(RColorBrewer)
data("world2MapEnv")
data("worldMapEnv")

map(database="world",xlim=c(-162,-150),ylim=c(16,26),mar = c(3.5,1,1,1),fill = TRUE,col = "darkgray")
grid(nx=NULL,ny=NULL,col = "darkgray",lty = 1)
axis(1, at=c(-162,-160,-158,-156,-154,-152,-150),cex.axis=0.8,labels = c(expression(162*degree*W),
      expression(160*degree*W),expression(158*degree*W),
      expression(156*degree*W),expression(154*degree*W),
      expression(152*degree*W),expression(150*degree*W)))
axis(2, at=c(16,18,20,22,24,26),cex.axis=0.8,labels = c(expression(16*degree*N),
      expression(18*degree*N),expression(20*degree*N),expression(22*degree*N),
      expression(24*degree*N),expression(26*degree*N)))
lines(rttrall$Longitude,rttrall$Latitude,col="#de2d26")
points(-157.68,21.28,col="#FECC5C",pch=17)
addscalebar(plotepsg = 4326,widthhint = 0.25,unitcategory = "metric",htin = 0.1,padin = c(0.15,0.15),style = "ticks",tick.cex = 0.7,lwd = 1,linecol = "black",labelpadin = 0.08,label.cex = 0.8,label.col = "black",pos = "bottomright")
addnortharrow(pos = "topleft",scale = 0.5)
```

# Map of tracks from one individual showing differences in foraging strategy (several short trips and one long trip)

```{r individual_track}
rttr04<-read.csv("~/Desktop/RTTR 2017/csv files/RTTR04_HALO_042617.csv")

map(database="world",xlim=c(-159,-156),ylim=c(17.5,22),mar = c(3.5,1,1,1),fill = TRUE,col = "darkgray")
grid(nx=NULL,ny=NULL,col = "darkgray",lty = 1)
axis(1, at=c(-159,-158,-157,-156),cex.axis=0.8,labels = c(expression(159*degree*W),
      expression(158*degree*W),expression(157*degree*W),
      expression(156*degree*W)))
axis(2, at=c(17,18,19,20,21,22),cex.axis=0.8,labels = c(expression(17*degree*N),
      expression(18*degree*N),expression(19*degree*N),expression(20*degree*N),
      expression(21*degree*N),expression(22*degree*N)))
lines(rttr04$Longitude,rttr04$Latitude,col="#de2d26")
points(-157.68,21.28,col="#FECC5C",pch=17)
addscalebar(plotepsg = 4326,widthhint = 0.25,unitcategory = "metric",htin = 0.1,padin = c(0.15,0.15),style = "ticks",tick.cex = 0.7,lwd = 1,linecol = "black",labelpadin = 0.08,label.cex = 0.8,label.col = "black",pos = "bottomright")
addnortharrow(pos = "topleft",scale = 0.4)
```

# Spatial Distribution
To visualize core foraging areas, I am creating a kernel density utilization distribution map. Colors are shaded from lighter to darker in relation to kernel levels (95, 75, 50).

```{r kernelUD}
library(adehabitatHR)
library(ggplot2)
library(maps)
library(mapdata)
library(ggmap)
library(ggsn)
library(marmap)
library(dplyr)
library(RColorBrewer)


fnames = dir("~/Desktop/RTTR 2017/csv files", pattern = ".csv",full.names = TRUE)
for (i in 1:length(fnames)){
  temp=read.csv(fnames[i])
  myfile=basename(fnames[i])
  loc=regexpr(pattern="[[:digit:]]{2}_",text = myfile)
  birdID = substr(myfile,start=loc[[1]],stop = loc[[1]]+1)
  temp$BIRDID= birdID
  if (i==1){
    rttrall = temp
  } else {
    rttrall = rbind(rttrall,temp)}
}

tracks.spdf = SpatialPointsDataFrame(coords=as.data.frame(cbind(rttrall$Longitude,rttrall$Latitude)),data=data.frame(id=rep(1,length=length(rttrall$Latitude))),proj4string = CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs"))

ud_island = kernelUD(tracks.spdf, h = "href")

ud50_island = getverticeshr(ud_island, percent=50, standardize=TRUE)
ud75_island = getverticeshr(ud_island, percent=75, standardize=TRUE)
ud95_island = getverticeshr(ud_island, percent=95, standardize=TRUE)

w<-map_data("worldHires")

kernelmap = ggplot()+
  coord_fixed(xlim = c(-162,-150),ylim=c(16,26))+
  geom_polygon(data=fortify(ud95_island),aes(x=long,y=lat,group=group),fill="#fee0d2",show.legend=T)+
  geom_polygon(data=fortify(ud75_island),aes(x=long,y=lat,group=group),fill="#fc9272",show.legend=T)+
  geom_polygon(data=fortify(ud50_island),aes(x=long,y=lat,group=group),fill="#de2d26",show.legend=T)+
  geom_polygon(data=w,aes(long,lat,group=group),fill="gray",color="gray50")+
  geom_point(aes(x=-157.68,y=21.28),pch=17,color="darkred",size=3)+
  xlab("")+ylab("")+
  scalebar(location = "bottomright",dist = 200,height = 0.02,st.dist = 0.02,st.size = 3,dd2km = TRUE,model = "WGS84",x.min = -162,x.max=-150,y.min = 16,y.max = 26)+
  north(location = "topleft",scale = 0.15,symbol = 3,x.min = -162,x.max=-150,y.min = 16,y.max = 26)+
  theme_bw()#
kernelmap


```

# Trip Parameters
To characterize foraging behavior, I would like to calculate mean trip duration, distance, and max range of short and long foraging trips. I also want to compare parameters between the sexes. I do not have the code for this section yet, but I know I want this information in a table and perhaps a bar graph with SD bars included.

```{r trip_parameters, eval=FALSE}
library(adehabitatLT)
library(oce)
library(geosphere)

temp=subset(rttrall,subset=rttrall$ID==1,select=c("ID","Date","Time","Latitude","Longitude"))
for (myrow in 1:nrow(temp)){
  
}


```

# Classification of Behavioral States
I would like to generate a map that shows behavioral states (transit vs. area-restricted search) for the foraging tracks. I do not have the code yet but know I will need to use the Residence in Space and Time (RST) algorithm to classify the behaviors. I may also plot daily activity patterns (stacked histogram?) and bar graphs of mean speed and altitude by behavioral state and time of day.

```{r behavioral_states}
library(adehabitatLT)
library(lubridate)
library(dplyr)
library(argosfilter)
library(ggplot2)
library(maptools)
library(maps)

#Converting .csv data to an ltraj object
rttrall$DateTimeGMT<-mdy_hms(paste(rttrall$Date,rttrall$Time,tz="GMT"))
rttrall$DateTimeHST<-rttrall$DateTimeGMT-hours(10)

coordinates(rttrall)<-cbind(rttrall$Longitude,rttrall$Latitude)
rttrdata<-as.ltraj(cbind(rttrall$Longitude,rttrall$Latitude),date=rttrall$DateTimeHST,id=rttrall$BIRDID)

#Calculate civil dawn and dusk, check times, filter as needed
HALO<-matrix(c(-157.68,21.28),nrow=1)
firstpoint<-rttrall[1,]
civildawn<-crepuscule(HALO,firstpoint$DateTimeHST,solarDep=6,direction="dawn",POSIXct.out=TRUE)
civildawnHST<-civildawn$time-hours(10)
civildusk<-crepuscule(HALO,firstpoint$DateTimeHST,solarDep=6,direction="dusk",POSIXct.out=TRUE)
civilduskHST<-civildusk$time-hours(10)

#Calculate residence time
res<-residenceTime(rttrdata,radius = .00774,maxt = 0.5,units = "hours")
plot(res,addlines=FALSE,addpoints=TRUE)

#Extract the residence time values from the class resiti object above
times<-res[[1]]$RT.0.00774

#Find the quartile values
quantile(times, na.rm = TRUE)

#Identify the top 25% residence time values
uppertimes<-res[[1]]$RT.0.00774>6647.99662

#Plot with ARS patches red
map(database="world",xlim=c(-162,-150),ylim=c(16,26),mar = c(3.5,1,1,1),fill = TRUE,col = "darkgray")
grid(nx=NULL,ny=NULL,col = "darkgray",lty = 1)
axis(1, at=c(-162,-160,-158,-156,-154,-152,-150),cex.axis=0.8,labels = c(expression(162*degree*W),
                                                                         expression(160*degree*W),expression(158*degree*W),
                                                                         expression(156*degree*W),expression(154*degree*W),
                                                                         expression(152*degree*W),expression(150*degree*W)))
axis(2, at=c(16,18,20,22,24,26),cex.axis=0.8,labels = c(expression(16*degree*N),
                                                        expression(18*degree*N),expression(20*degree*N),expression(22*degree*N),
                                                        expression(24*degree*N),expression(26*degree*N)))

plot(rttrall, pch = 16, cex = 0.5)
lines(rttrall$Longitude,rttrall$Latitude)
points(rttrall$Longitude[uppertimes==TRUE],rttrall$Latitude[uppertimes==TRUE],col="red", pch=16, cex = 0.3)


```

# Stable Isotopes
Lastly, I want to plot stable carbon and nitrogen values of blood and feather samples (and possibly distinguished by sex) to look at diet characteristics between the breeding and non-breeding season. However, this depends on when I get my stable isotope results back from the lab. No code for this yet but if I get my results back in time, it will be a basic scatterplot with carbon isotope values on the x-axis, nitrogen isotope values on the y-axis, and SD included on each plot point.
```{r stable_isotopes}

```

